---
title: Redis for Pivotal Cloud Foundry
---

Automated Backup functionality is on the roadmap to be added in a future release. In the interim, the following manual backup & restore steps can be followed.

# Manual Backups

It is possible to create a backup of an instance manually by following these steps

* [Follow these steps to login to your OpsManager installation and target the Redis tile deployment](http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#ssh)
* Identify the VM which holds your instance by running `bosh vms`
  * For the `shared-vm` plan this will be the job name containing `cf-redis-broker`
  * For the `dedicated-vm` plan this will be the job name containing `dedicated-node`.
  * You can identify the exact node for your `dedicated-vm` service instance by comparing the IP Address from your application bindings

An example output from `bosh vms`
<%= image_tag("bosh_vms.jpeg") %>

* target your redis deployment with `bosh deployment`
* `bosh ssh` into you desired node

Persistence is enabled on these plans through the use of `RDB` files, using the following Redis config rules
```
save 900 1
save 300 10
save 60 10000
```

## Shared-VM plan

You can either take the latest RDB file held on disk which is generated by the above the rules, or trigger a recent update by using the `redis-cli` to trigger a `BGSAVE`. Credentials to log into the `redis-cli` can be obtained from `VCAP_SERVICES` for your bound application.

The `redis-cli` is located in `/var/vcap/packages/redis/bin/redis-cli`

On this plan the `BGSAVE` command is aliased to a random string, this can be obtained from Ops Manager in the credentials tab.

### Steps to backup

* `bosh ssh` into your desired node, see above section to identify the correct VM
* change to Root using `sudo -i`
* copy the contents of the `/var/vcap/store/cf-redis-broker` directory to a zip or tar file
* backup the folder / compressed file to your chosen location

the `/var/vcap/store/cf-redis-broker` has sub-directories for each instance created of this plan. The backup file for each instance is called `dump.rdb`

For example, here are two instances:
```
root@66358f3e-3428-46df-9bb3-9acc7770b188:/var/vcap/store/cf-redis-broker# find -type f | xargs ls -1
./redis-data/3124f373-e9e2-44e1-ad12-a8865d8978b0/db/dump.rdb
./redis-data/3124f373-e9e2-44e1-ad12-a8865d8978b0/redis.conf
./redis-data/3124f373-e9e2-44e1-ad12-a8865d8978b0/redis-server.pid
./redis-data/62333bf9-f023-4566-b233-6686f26b8f4d/db/dump.rdb
./redis-data/62333bf9-f023-4566-b233-6686f26b8f4d/redis.conf
./redis-data/62333bf9-f023-4566-b233-6686f26b8f4d/redis-server.pid
./statefile.json
```

## Dedicated-VM plan

You can either take the latest RDB file on disk, as generated by the above rules or trigger a more recent RDB file by executing the `BGSAVE` command using the `redis-cli`. Credentials can be obtained from the `VCAP_SERVICES` from your bound application.
The `redis-cli` can be found in `/var/vcap/packages/redis/bin/redis-cli`

### Steps to backup

* `bosh ssh` into your desired node, see above section to identify the correct VM
* change to Root using `sudo -i`
* copy the contents of the `/var/vcap/store/redis` directory to a zip or tar file
* backup the folder / compressed file to your chosen location

The backup file will be named `dump.rdb`

## Restore Locally
You can choose to restore the RDB file to a local Redis instance if you wish.

The steps to do this will depend on your configuration and setup.
[Refer to the Redis documentation for more details](http://redis.io/documentation)

## Restore to PCF
You can also restore your backup file to another instance of the `Redis for PCF` tile.

The below steps are manual, these will be replaced by an automated operator friendly script in a future release of the product.

Before restoring your RDB file you must have these pre-requisites:

* Same resource configuration as the instance from which you backed up
  * The persistent disk should be increased to be `3.5 x size of the RDB file` if it not already so.
  * This is to allow space for the temporary files used during the restore process

To restore your backup file, to another instance of the `Redis for PCF` tile and the `dedicated-vm` plan

1. Create a new instance of the plan that you wish to restore to
1. Identify the VM which the instance of your plan is located on, by following the steps from the `Manual Backups` section above
1. `bosh ssh` into the identified VM
1. copy the RDB file you wish to restore to `/var/vcap/store/` as root or using `sudo`
1. stop all running `Redis` processed by running `sudo monit stop all`
1. Identify the location of the master `redis.conf` file with `find /var/vcap/data/jobs/ -name redis.conf`
  1. For example, `/var/vcap/data/jobs/dedicated-node/f0ff6d25683b2ab7b14ee0b4b5eb9bd8e9ce8cfc-d59095917f58e170c252500ed7873cb8c359b757/config/redis.conf`
1. Open the file identified in an editor such as `vim`
  1. modify the following value:
    1. from: `appendonly yes`
    1. to: `appendonly no`
  1. exit & save
1. For the `dedicated-vm` plan replace the file `/var/vcap/store/redis/dump.rdb` with the file you copied over in step 4, making sure to retain the filename `dump.rdb`
1. For the `shared-vm` plan replace the file `/var/vcap/store/cf-redis-broker/redis-data/<guid>/dump.rdb` with the file you copied over in step 4, making sure to retain the filename `dump.rdb`
1. confirm the file size of `dump.rdb` is as you expect by running `ls -alh`
1. restart the processes by running `sudo monit start all`
1. Redis will now load the restored `dump.rdb` file into memory and write it back out to the AOF file
  1. the amount of time this takes will depend upon your dataset size and other factors
  1. to view progress you can use the `redis-cli` and run the `info` command
  1. wait until you see `aof_rewrite_in_progress:0`
1. stop the running Redis process with `sudo monit stop all`
1. Reverse the configuration changes in step 9 so you have `appendonly yes`
1. start the processes again with `sudo monit start all`
1. you have now restored your Redis data
